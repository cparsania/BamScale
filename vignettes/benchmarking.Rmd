---
title: "BamScale Benchmarking (Full BAM)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BamScale Benchmarking (Full BAM)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  dpi = 150
)
```

## Overview

This vignette benchmarks BamScale on a full BAM from `chipseqDBData` with:

-   Step 1 fields: `qname, flag, rname, pos, mapq, cigar`
-   Sequence + quality: `qname, seq, qual`
-   `GAlignments` output

BamScale is evaluated at `1`, `4`, and `8` threads.

## Package checks

```{r packages, message = FALSE}
library(BamScale)

cran_pkgs <- c("dplyr", "forcats", "ggplot2", "purrr", "stringr", "tibble")
bioc_pkgs <- c("Rsamtools", "ExperimentHub", "chipseqDBData", "GenomicAlignments")

missing_cran <- cran_pkgs[!vapply(cran_pkgs, requireNamespace, logical(1), quietly = TRUE)]
missing_bioc <- bioc_pkgs[!vapply(bioc_pkgs, requireNamespace, logical(1), quietly = TRUE)]

if (length(missing_cran) > 0L || length(missing_bioc) > 0L) {
  cran_line <- if (length(missing_cran) > 0L) {
    paste0("install.packages(c(", paste(sprintf('"%s"', missing_cran), collapse = ", "), "))")
  } else {
    "# no missing CRAN packages"
  }

  bioc_line <- if (length(missing_bioc) > 0L) {
    paste0("BiocManager::install(c(", paste(sprintf('"%s"', missing_bioc), collapse = ", "), "))")
  } else {
    "# no missing Bioconductor packages"
  }

  stop(
    paste0(
      "Missing required packages.\n",
      "CRAN: ", if (length(missing_cran) == 0L) "none" else paste(missing_cran, collapse = ", "), "\n",
      "Bioconductor: ", if (length(missing_bioc) == 0L) "none" else paste(missing_bioc, collapse = ", "), "\n\n",
      "Install with:\n",
      "if (!requireNamespace(\"BiocManager\", quietly = TRUE)) install.packages(\"BiocManager\")\n",
      cran_line, "\n",
      bioc_line
    ),
    call. = FALSE
  )
}

library(dplyr)
library(forcats)
library(ggplot2)
library(purrr)
library(stringr)
library(tibble)
```

## Select BAM from chipseqDBData

```{r bam-file}
chip_tbl <- chipseqDBData::H3K9acData() |> tibble::as_tibble()

if (nrow(chip_tbl) == 0L || !("Path" %in% colnames(chip_tbl))) {
  stop("chipseqDBData::H3K9acData() returned no BAM paths")
}

chip_tbl <- chip_tbl |>
  mutate(
    reads_num = if ("Reads" %in% colnames(chip_tbl)) suppressWarnings(as.numeric(gsub("[^0-9.]+", "", as.character(.data$Reads)))) else NA_real_
  )

row_id <- if (all(is.na(chip_tbl$reads_num))) 1L else which.max(chip_tbl$reads_num)
bam_file <- chip_tbl$Path[[row_id]]

if (!methods::is(bam_file, "BamFile")) {
  stop("Expected BamFile in chipseqDBData path column")
}

bam <- tryCatch(
  BiocGenerics::path(bam_file),
  error = function(e) {
    if ("path" %in% names(bam_file)) {
      bam_file$path
    } else {
      stop("Unable to extract BAM path from BamFile: ", conditionMessage(e))
    }
  }
)

if (!file.exists(bam)) {
  stop("Downloaded BAM file not found: ", bam)
}

sample_name <- if ("Name" %in% colnames(chip_tbl)) as.character(chip_tbl$Name[[row_id]]) else paste0("sample_", row_id)
read_hint <- if (is.na(chip_tbl$reads_num[[row_id]])) "unknown" else format(chip_tbl$reads_num[[row_id]], big.mark = ",")
file_mb <- round(file.size(bam) / 1024^2, 2)

cat("Dataset : chipseqDBData::H3K9acData()\n")
cat("Sample  :", sample_name, "\n")
cat("Reads   :", read_hint, "(metadata)\n")
cat("File    :", basename(bam), "\n")
cat("Size    :", file_mb, "MB\n")
```

## Helpers

```{r helpers}
is_ci <- identical(tolower(Sys.getenv("CI")), "true")
n_iter <- if (is_ci) 1L else 3L
thread_set <- c(1L, 4L, 8L)

bench_times <- function(method, benchmark, fun, n = n_iter, warmup = TRUE) {
  if (isTRUE(warmup)) invisible(fun())
  elapsed <- map_dbl(seq_len(n), function(i) {
    gc(verbose = FALSE)
    system.time(fun())[["elapsed"]]
  })

  tibble(
    benchmark = benchmark,
    method = method,
    min_s = min(elapsed),
    median_s = median(elapsed),
    max_s = max(elapsed),
    n = n
  )
}

add_throughput <- function(df, n_records, mb_size) {
  df |>
    mutate(
      records_per_s = n_records / median_s,
      mb_per_s = mb_size / median_s
    )
}

label_threads <- function(prefix, t) {
  paste0(prefix, " (", t, " thread", if (t == 1L) "" else "s", ")")
}

scan_param <- function(what) {
  Rsamtools::ScanBamParam(what = as.character(what))
}

scanbam_to_tibble <- function(x) {
  x <- x[[1L]]
  tibble(
    qname = x$qname,
    flag = x$flag,
    rname = as.character(x$rname),
    pos = x$pos,
    mapq = x$mapq,
    cigar = x$cigar
  )
}

plot_benchmark <- function(df, title, subtitle = NULL) {
  palette_tool <- c(
    "BamScale" = "#3B7DD8",
    "Rsamtools" = "#D84315",
    "GenomicAlignments" = "#2E7D32"
  )

  df |>
    mutate(
      tool = case_when(
        str_detect(method, "^BamScale") ~ "BamScale",
        str_detect(method, "Rsamtools") ~ "Rsamtools",
        TRUE ~ "GenomicAlignments"
      ),
      method = forcats::fct_inorder(method)
    ) |>
    ggplot(aes(x = method, y = median_s, fill = tool)) +
    geom_col(width = 0.65, colour = "grey30", linewidth = 0.3) +
    geom_errorbar(aes(ymin = min_s, ymax = max_s), width = 0.2, linewidth = 0.4) +
    scale_fill_manual(values = palette_tool, drop = FALSE) +
    labs(
      title = title,
      subtitle = subtitle,
      x = NULL,
      y = "Elapsed time (seconds)",
      fill = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 30, hjust = 1),
      legend.position = "top",
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank()
    )
}
```

## Benchmark 1: Step 1 Fields

```{r bench-step1}
fields_step1 <- c("qname", "flag", "rname", "pos", "mapq", "cigar")

ref_step1 <- bam_read(
  file = bam,
  what = fields_step1,
  as = "data.frame",
  threads = 1L
) |>
  as_tibble()

n_step1 <- nrow(ref_step1)

res_step1 <- map_dfr(thread_set, function(t) {
  bench_times(
    method = label_threads("BamScale", t),
    benchmark = "Step1",
    fun = function() bam_read(file = bam, what = fields_step1, as = "data.frame", threads = t)
  )
}) |>
  bind_rows(
    bench_times(
      method = "Rsamtools scanBam (raw list)",
      benchmark = "Step1",
      fun = function() Rsamtools::scanBam(bam, param = scan_param(fields_step1))
    ),
    bench_times(
      method = "Rsamtools scanBam (+tibble)",
      benchmark = "Step1",
      fun = function() scanbam_to_tibble(Rsamtools::scanBam(bam, param = scan_param(fields_step1)))
    )
  ) |>
  add_throughput(n_records = n_step1, mb_size = file_mb)

res_step1 |>
  arrange(median_s) |>
  knitr::kable(digits = 4, caption = "Step 1 fields benchmark (full BAM)")
```

```{r plot-step1}
plot_benchmark(
  res_step1,
  title = "Step 1 fields benchmark",
  subtitle = paste0(basename(bam), " | full BAM | ", n_step1, " records")
)
```

## Benchmark 2: Sequence + Quality

```{r bencbenchh-seqqual}
fields_seqqual <- c("qname", "seq", "qual")

ref_seqqual <- bam_read(
  file = bam,
  what = fields_seqqual,
  as = "data.frame",
  threads = 1L
) |>
  as_tibble()

n_seqqual <- nrow(ref_seqqual)

res_seqqual <- map_dfr(thread_set, function(t) {
  bench_times(
    method = label_threads("BamScale", t),
    benchmark = "SeqQual",
    fun = function() bam_read(file = bam, what = fields_seqqual, as = "data.frame", threads = t)
  )
}) |>
  bind_rows(
    bench_times(
      method = "Rsamtools scanBam seq+qual",
      benchmark = "SeqQual",
      fun = function() Rsamtools::scanBam(bam, param = scan_param(fields_seqqual))
    )
  ) |>
  add_throughput(n_records = n_seqqual, mb_size = file_mb)

res_seqqual |>
  arrange(median_s) |>
  knitr::kable(digits = 4, caption = "Sequence + quality benchmark (full BAM)")
```

```{r plot-seqqual}
plot_benchmark(
  res_seqqual,
  title = "Sequence + quality benchmark",
  subtitle = paste0(basename(bam), " | full BAM | ", n_seqqual, " reads")
)
```

## Benchmark 3: GAlignments

```{r bench-galignments}
ga_fields <- c("qname", "rname", "pos", "cigar", "strand", "flag")

ga_ref <- bam_read(
  file = bam,
  what = ga_fields,
  as = "GAlignments",
  threads = 1L
)

ga_n <- length(ga_ref)

res_ga <- map_dfr(thread_set, function(t) {
  bench_times(
    method = label_threads("BamScale GAlignments", t),
    benchmark = "GAlignments",
    fun = function() bam_read(file = bam, what = ga_fields, as = "GAlignments", threads = t)
  )
}) |>
  bind_rows(
    bench_times(
      method = "GenomicAlignments readGAlignments",
      benchmark = "GAlignments",
      fun = function() GenomicAlignments::readGAlignments(bam, param = scan_param(ga_fields))
    )
  ) |>
  add_throughput(n_records = ga_n, mb_size = file_mb)

res_ga |>
  arrange(median_s) |>
  knitr::kable(digits = 4, caption = "GAlignments benchmark (full BAM)")
```

```{r plot-galignments}
plot_benchmark(
  res_ga,
  title = "GAlignments benchmark",
  subtitle = paste0(basename(bam), " | full BAM | ", ga_n, " alignments")
)
```

## Combined summary

```{r summary}
bind_rows(res_step1, res_seqqual, res_ga) |>
  select(benchmark, method, median_s, records_per_s, mb_per_s) |>
  arrange(benchmark, median_s) |>
  knitr::kable(digits = 4, caption = "Combined benchmark summary")
```

## Session info

```{r session}
sessionInfo()
```