#!/usr/bin/env sh

if [ "$(uname)" = "Darwin" ] ; then
cat <<EOC > test-omp.c
#include <omp.h>
int main() {
  return omp_get_num_threads();
}
EOC

R_OPENMP="work"
"${R_HOME}/bin/R" CMD SHLIB test-omp.c >/dev/null 2>&1 || R_OPENMP="fail"

if [ "$R_OPENMP" = "fail" ]; then
  R_OPENMP="work"
  "${R_HOME}/bin/R" CMD SHLIB -Xclang -fopenmp test-omp.c >/dev/null 2>&1 || R_OPENMP="fail"
fi

rm -f test-omp.* a.out

if [ ! -e "./src/Makevars.tmp" ]; then
  touch ./src/Makevars.tmp
fi

if [ "$R_OPENMP" = "work" ]; then
  echo "BAMSCALE_PKG_CXXFLAGS = -Xclang -fopenmp" > ./src/Makevars.tmp
  echo "BAMSCALE_PKG_LIBS = -lomp" >> ./src/Makevars.tmp
  echo "" >> ./src/Makevars.tmp
else
  echo "BAMSCALE_PKG_CXXFLAGS=" > ./src/Makevars.tmp
  echo "BAMSCALE_PKG_LIBS=" >> ./src/Makevars.tmp
  echo "" >> ./src/Makevars.tmp
fi

cat ./src/Makevars.tmp ./src/Makevars.in > ./src/Makevars
rm ./src/Makevars.tmp

elif [ "$(expr substr $(uname -s) 1 5)" = "Linux" ] ; then
if [ ! -e "./src/Makevars.tmp" ]; then
  touch ./src/Makevars.tmp
fi

echo "BAMSCALE_PKG_CXXFLAGS = \$(SHLIB_OPENMP_CXXFLAGS)" > ./src/Makevars.tmp
echo "BAMSCALE_PKG_LIBS = \$(SHLIB_OPENMP_CXXFLAGS)" >> ./src/Makevars.tmp
echo "" >> ./src/Makevars.tmp

cat ./src/Makevars.tmp ./src/Makevars.in > ./src/Makevars
rm ./src/Makevars.tmp
fi
