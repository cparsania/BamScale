name: Render Benchmark Vignette

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  render-vignette:
    runs-on: ubuntu-latest
    env:
      R_KEEP_PKG_SOURCE: yes
      _R_CHECK_FORCE_SUGGESTS_: true
      EXPERIMENT_HUB_CACHE: ${{ runner.temp }}/ExperimentHub
      BAMSCALE_BENCH_FULL: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install Bioconductor and CRAN dependencies
        shell: Rscript {0}
        run: |
          install.packages("BiocManager")
          options(repos = BiocManager::repositories())

          BiocManager::install(
            c(
              "ompBAM",
              "Rsamtools",
              "GenomicAlignments",
              "GenomicRanges",
              "GenomeInfoDb",
              "IRanges",
              "S4Vectors",
              "ExperimentHub",
              "chipseqDBData"
            ),
            ask = FALSE,
            update = FALSE
          )

          install.packages(c("dplyr", "forcats", "ggplot2", "purrr", "stringr", "tibble", "knitr", "rmarkdown", "testthat"))

      - name: Install BamScale
        shell: Rscript {0}
        run: install.packages(".", repos = NULL, type = "source", INSTALL_opts = "--no-build-vignettes")

      - name: Render benchmarking vignette
        shell: Rscript {0}
        run: |
          rmarkdown::render(
            "vignettes/benchmarking.Rmd",
            output_format = "rmarkdown::html_vignette",
            output_dir = "vignettes",
            clean = TRUE,
            quiet = FALSE
          )
